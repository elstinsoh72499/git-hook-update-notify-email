#!/usr/bin/env ruby


$:.unshift File.dirname(__FILE__) + '/../lib'
require 'git-hook-update-notify-email'
require 'trollop'

include GitHookUpdateNotifyEmail


opts = Trollop::options do
  opt :config, "The config file to ActionMailer", :type => String
  opt :to, "the list email to send mail", :type => String
end

refname = ARGV.shift
old_sha1 = ARGV.shift
new_sha1 = ARGV.shift

unless opts[:config].nil?
  mailconfig = YAML::load_file(opts[:config])
  mailconfig.each do |k, v|
    v.symbolize_keys! if v.respond_to?(:symbolize_keys!)
    ActionMailer::Base.send("#{k}=", v)
  end
else
  ActionMailer::Base.delivery_method = :sendmail
end

git_rev = GitRevision.get_all_revision(refname, old_sha1, new_sha1)
git_rev.each do |rev|
  GitDiffMail.deliver_git_diff_mail(rev, opts[:to])
end
#!vim: syntax
